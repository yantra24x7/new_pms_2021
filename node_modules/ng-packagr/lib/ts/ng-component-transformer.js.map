{"version":3,"file":"ng-component-transformer.js","sourceRoot":"","sources":["../../../src/lib/ts/ng-component-transformer.ts"],"names":[],"mappings":"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","sourcesContent":["import * as ts from 'typescript';\nimport * as path from 'path';\nimport { transformComponent } from './transform-component';\nimport { isSynthesizedSourceFile, replaceWithSynthesizedSourceText, writeSourceFile } from './synthesized-source-file';\n\n/**\n * Call signature for a transformer applied to `@Component({ templateUrl: '...' })`.\n *\n * A `TemplateTransformer` will update the property assignment for `templateUrl` in the decorator.\n */\nexport interface TemplateTransformer {\n  (\n    {\n\n    }: {\n      node: ts.Node;\n      sourceFile: ts.SourceFile;\n      sourceFilePath: string;\n      templatePath: string;\n      templateFilePath: string;\n    }\n  ): string | undefined | void;\n}\n\n/**\n * Call signature for a transformer applied to `@Component({ styleUrls: ['...'] })`.\n *\n * A `StylesheetTransformer` will update the property assignment for `stylesUrl` in the decorator.\n *\n * WATCH OUT! A stylesheet transformer is called for every url in the `stylesUrl` array!\n */\nexport interface StylesheetTransformer {\n  (\n    {\n\n    }: {\n      node: ts.Node;\n      sourceFile: ts.SourceFile;\n      sourceFilePath: string;\n      stylePath: string;\n      styleFilePath: string;\n    }\n  ): string | undefined | void;\n}\n\nexport interface ComponentSourceFileTransformer {\n  (\n    {\n\n    }: {\n      template: TemplateTransformer;\n      stylesheet: StylesheetTransformer;\n    }\n  ): ts.TransformerFactory<ts.SourceFile>;\n}\n\nexport const transformComponentSourceFiles: ComponentSourceFileTransformer = ({ template, stylesheet }) =>\n  transformComponent({\n    templateUrl: node => {\n      const sourceFile = node.getSourceFile();\n      const sourceFilePath = node.getSourceFile().fileName;\n      // XX: strip quotes (' or \") from path\n      const templatePath = node.initializer.getText().substring(1, node.initializer.getText().length - 1);\n      const templateFilePath = path.resolve(path.dirname(sourceFilePath), templatePath);\n\n      // Call the transformer\n      const inlinedTemplate = template({ node, sourceFile, sourceFilePath, templatePath, templateFilePath });\n\n      if (typeof inlinedTemplate === 'string') {\n        // Apply the transformer result, thus altering the source file\n        const synthesizedNode = ts.updatePropertyAssignment(\n          node,\n          ts.createIdentifier('template'),\n          ts.createLiteral(inlinedTemplate)\n        );\n\n        const synthesizedSourceText = 'template: `'.concat(inlinedTemplate).concat('`');\n        replaceWithSynthesizedSourceText(node, synthesizedSourceText);\n\n        return synthesizedNode;\n      } else {\n        return node;\n      }\n    },\n    styleUrls: node => {\n      const sourceFile = node.getSourceFile();\n      const sourceFilePath = node.getSourceFile().fileName;\n\n      // Handle array arguments for styleUrls\n      const styleUrls = node.initializer\n        .getChildren()\n        .filter(node => node.kind === ts.SyntaxKind.SyntaxList)\n        .map(node => node.getChildren().map(n => n.getText()))\n        .reduce((prev, current) => prev.concat(...current), [])\n        .filter(text => text !== ',')\n        .map(url => url.substring(1, url.length - 1));\n\n      // Call the transformation for each value found in `stylesUrls: []`.\n      const stylesheets = styleUrls.map((url: string) => {\n        const styleFilePath = path.resolve(path.dirname(sourceFilePath), url);\n\n        // Call the stylesheet transformer\n        const content = stylesheet({ node, sourceFile, sourceFilePath, stylePath: url, styleFilePath });\n\n        return typeof content === 'string' ? content : url;\n      });\n\n      // Check if the transformer manipulated the metadata of the `@Component({..})` decorator\n      const hasChanged = stylesheets.every((value, index) => {\n        return styleUrls[index] && styleUrls[index] !== value;\n      });\n\n      if (hasChanged) {\n        // Apply the transformation result, thus altering the source file\n        const synthesizedNode = ts.updatePropertyAssignment(\n          node,\n          ts.createIdentifier('styles'),\n          ts.createArrayLiteral(stylesheets.map(value => ts.createLiteral(value)))\n        );\n\n        const synthesizedSourceText = 'styles: ['\n          .concat(stylesheets.map(value => `\\`${value}\\``).join(', '))\n          .concat(']');\n        replaceWithSynthesizedSourceText(node, synthesizedSourceText);\n\n        return synthesizedNode;\n      } else {\n        return node;\n      }\n    },\n    file: sourceFile => {\n      // XX ... the string replacement is quite hacky.\n      // Why can't we use `ts.SourceFile#update()`?\n      // It produces a `FalseExpression` error, somehow.\n      if (isSynthesizedSourceFile(sourceFile['original'])) {\n        sourceFile['__replacements'] = sourceFile['original'].__replacements;\n        return writeSourceFile(sourceFile);\n      }\n\n      return sourceFile;\n    }\n  });\n"]}